---
layout: post
title: 内存那些事儿
subtitle: 关于操作系统的内存管理
author: Hayden Wang
header-img: memory.jpg
cdn: header-on
tags: [Computer Science]
date: 2018-02-26 22:47:30
---

## 计算机存储层次

硬盘 -> 内存 -> 缓存 -> 寄存器

寻址空间
32位 -> 4G
64位 -> 10^19 Bytes
64位JVM




寻址

指针指向逻辑内存，逻辑内存映射物理内存，物理内存不够用使用虚拟内存（分页载入）


## 逻辑地址和物理地址

所谓的逻辑地址，是指计算机用户(例如程序开发者)看到的地址。例如，当创建一个长度为 100 的整型数组时，操作系统返回一个逻辑上的连续空间: 指针指向数组第一个元素的内存地址。由于整型元素的大小为 4 个字节，故第二个元素的地址时起始地址加 4，以此类推。事实上，逻辑地址并不一定是元素存储的真实地址，即数组元素的物理地址(在内存条中所处的位置)，物理地址并不是连续的，只不过操作系统通过地址映射，将逻辑地址映射成连续的， 这样更符合人们的直观思维。

## 虚拟内存

另一个重要概念是虚拟内存。操作系统读写内存的速度可以比读写磁盘的速度快几个量级。但是，内存价格也相对较高，不能大规模扩展。于是，操作系统可以将部分不太常用的数据移出内存，存放到价格相对较低的磁盘缓存，以实现内存扩展。操作系统还可以通过算法预测哪部分存储到磁盘缓存的数据需要进行读写，提前把这部分数据读回内存。虚拟内存空间相对磁盘而言要小很多，因此，即使搜索虚拟内存空间也比直接搜索磁盘要快。唯一慢于磁盘的可能是，内存、虚拟内存中都没有所需要的数据，最终还需要从硬盘中直接读取。这就是为什么内存和虚拟内存中需要存储会被重复读写的数据，否则就失去了缓存的意义。

现代计算机中有一个专门的转译缓冲区(Translation Lookaside Buffer，TLB)，用来实现虚拟地址到物理地址的快速转换。

与内存/虚拟内存相关的还有以下两个概念: 
(1) Resident Set
当一个进程在运行的时候，操作系统不会一次性加载进程的所有数据到内存，只会加载一部分正在用，以及预期要用的数据。其他数据可能存储在虚拟内存，交换区和硬盘文件系统上。被加载到内存的部分就是 resident set。
(2) Thrashing
由于 resident set 包含预期要用的数据，理想情况下，进程运行过程中用到的数据都会逐步加载进resident set。但事实往往并非如此:每当需要的内存页面(page)不在 resident set 中时，操作系统必须从虚拟内存或硬盘中读数据，这个过程被称为内存页面错误(page faults)。当操作系统需要花费大量时间去处理页面错误的情况就是 thrashing。